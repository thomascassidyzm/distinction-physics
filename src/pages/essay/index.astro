---
import GuidePanel from '../../components/GuidePanel.astro';
import { sections as sectionContent } from '../../content/essay-1/sections';
import { sections as sectionMeta, essayMeta, epistemicStatusDescriptions } from '../../content/essay-1/config';
import { VERSION, BUILD } from '../../lib/version';

function parseMarkdown(text: string): string {
  return text
    .split('\n\n')
    .map(para => {
      // Handle list items
      if (para.startsWith('- ')) {
        const items = para.split('\n').map(line =>
          line.startsWith('- ') ? `<li>${line.slice(2)}</li>` : line
        ).join('');
        return `<ul>${items}</ul>`;
      }
      // Handle bold and italic
      let processed = para
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/`(.+?)`/g, '<code>$1</code>');
      return `<p>${processed}</p>`;
    })
    .join('\n');
}
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{essayMeta.title}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Sora:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
  <header class="site-header">
    <nav class="header-nav">
      <a href="/" class="site-title">Distinction Physics</a>
      <div class="header-meta">
        <span class="version">{VERSION}</span>
        <span class="build">build {BUILD}</span>
        <span class="status">{essayMeta.status}</span>
        <span class="date">{essayMeta.date}</span>
      </div>
    </nav>
    <div class="read-modes">
      <button class="mode-btn active" data-mode="essay">Essay</button>
      <button class="mode-btn" data-mode="overview">Overview</button>
      <button class="mode-btn" data-mode="academic">Academic</button>
    </div>
  </header>

  <aside class="section-nav">
    <div class="nav-title">Sections</div>
    {sectionMeta.map((section) => (
      <a
        href={`#${section.id}`}
        class="nav-item"
        data-section={section.id}
      >
        <span class="nav-number">{section.number}</span>
        <span class="nav-label">{section.shortTitle}</span>
        <span class={`nav-status ${section.epistemicStatus}`}></span>
      </a>
    ))}
    <div class="nav-legend">
      <div class="legend-title">Epistemic Status</div>
      <div class="legend-item"><span class="legend-dot established"></span> Established</div>
      <div class="legend-item"><span class="legend-dot derived"></span> Derived</div>
      <div class="legend-item"><span class="legend-dot contested"></span> Contested</div>
      <div class="legend-item"><span class="legend-dot open"></span> Open</div>
    </div>
  </aside>

  <main class="essay-content">
    <article>
      <header class="essay-header">
        <h1>{essayMeta.title}</h1>
        <p class="subtitle">{essayMeta.subtitle}</p>
      </header>

      {sectionMeta.map((meta, i) => {
        const content = sectionContent.find(s => s.id === meta.id);
        if (!content) return null;
        return (
          <section id={meta.id} class="essay-section" data-status={meta.epistemicStatus}>
            <div class="section-header">
              <span class="section-number">{meta.number}</span>
              <h2>{meta.title}</h2>
              <span class={`section-status ${meta.epistemicStatus}`} title={epistemicStatusDescriptions[meta.epistemicStatus]}>
                {meta.epistemicStatus}
              </span>
            </div>
            <div class="section-body essay-mode" set:html={parseMarkdown(content.content)} />
            <div class="section-body overview-mode hidden">
              <ul class="key-points">
                {content.keyPoints?.map(point => (
                  <li>{point}</li>
                ))}
              </ul>
            </div>
            <div class="section-body academic-mode hidden">
              <div class="academic-abstract">
                <strong>Abstract:</strong> This section addresses {meta.title.toLowerCase()}.
                Epistemic status: <span class={meta.epistemicStatus}>{meta.epistemicStatus}</span>.
              </div>
              <div class="academic-content" set:html={parseMarkdown(content.content)} />
            </div>
          </section>
        );
      })}
    </article>
  </main>

  <GuidePanel />

  <script is:inline>
    // Track current section for guide context
    window.currentSectionId = 'foundations';
    window.currentSection = 'Foundations';
    window.currentStatus = 'established';

    // Intersection observer for section tracking
    document.addEventListener('DOMContentLoaded', () => {
      const sections = document.querySelectorAll('.essay-section');
      const navItems = document.querySelectorAll('.nav-item');

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const section = entry.target;
            const id = section.id;
            const status = section.dataset.status;

            // Update global context
            window.currentSectionId = id;
            window.currentSection = section.querySelector('h2')?.textContent || id;
            window.currentStatus = status;

            // Update nav highlighting
            navItems.forEach(item => {
              item.classList.toggle('active', item.dataset.section === id);
            });
          }
        });
      }, { threshold: 0.3 });

      sections.forEach(section => observer.observe(section));

      // Read mode switching
      const modeBtns = document.querySelectorAll('.mode-btn');
      modeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const mode = btn.dataset.mode;
          modeBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          document.querySelectorAll('.section-body').forEach(body => {
            body.classList.add('hidden');
            if (body.classList.contains(`${mode}-mode`)) {
              body.classList.remove('hidden');
            }
          });
        });
      });
    });
  </script>
</body>
</html>

<style>
  :root {
    --void: #0a0a0c;
    --depth-1: #12121a;
    --depth-2: #1a1a24;
    --border: #2a2a3a;
    --text-primary: #e8e8f0;
    --text-secondary: #a0a0b8;
    --text-muted: #606080;
    --accent: #4a9eff;
    --established: #4a9eff;
    --derived: #50c878;
    --contested: #ffa500;
    --open: #a855f7;
    --font-display: 'Cormorant Garamond', serif;
    --font-body: 'Sora', sans-serif;
    --font-mono: 'JetBrains Mono', monospace;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: var(--font-body);
    background: var(--void);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
  }

  .site-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 420px;
    height: 60px;
    background: var(--depth-1);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 2rem;
    z-index: 50;
  }

  .header-nav {
    display: flex;
    align-items: center;
    gap: 2rem;
  }

  .site-title {
    font-family: var(--font-display);
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    text-decoration: none;
  }

  .header-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 0.75rem;
    color: var(--text-muted);
    font-family: var(--font-mono);
  }

  .read-modes {
    display: flex;
    gap: 0.25rem;
    background: var(--void);
    padding: 0.25rem;
    border-radius: 6px;
  }

  .mode-btn {
    padding: 0.375rem 0.75rem;
    background: transparent;
    border: none;
    border-radius: 4px;
    color: var(--text-muted);
    font-size: 0.75rem;
    font-family: var(--font-body);
    cursor: pointer;
    transition: all 0.2s;
  }

  .mode-btn.active {
    background: var(--depth-2);
    color: var(--text-primary);
  }

  .mode-btn:hover:not(.active) {
    color: var(--text-secondary);
  }

  .section-nav {
    position: fixed;
    left: 0;
    top: 60px;
    width: 260px;
    height: calc(100vh - 60px);
    background: var(--depth-1);
    border-right: 1px solid var(--border);
    padding: 1.5rem 0;
    overflow-y: auto;
  }

  .nav-title {
    padding: 0 1.5rem 1rem;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 1.5rem;
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 0.875rem;
    transition: all 0.2s;
  }

  .nav-item:hover {
    background: var(--depth-2);
    color: var(--text-primary);
  }

  .nav-item.active {
    background: rgba(74, 158, 255, 0.1);
    color: var(--accent);
    border-left: 2px solid var(--accent);
  }

  .nav-number {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--text-muted);
    min-width: 2rem;
  }

  .nav-status {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    margin-left: auto;
  }

  .nav-status.established { background: var(--established); }
  .nav-status.derived { background: var(--derived); }
  .nav-status.contested { background: var(--contested); }
  .nav-status.open { background: var(--open); }

  .nav-legend {
    margin-top: 2rem;
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border);
  }

  .legend-title {
    font-size: 0.625rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-bottom: 0.375rem;
  }

  .legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .legend-dot.established { background: var(--established); }
  .legend-dot.derived { background: var(--derived); }
  .legend-dot.contested { background: var(--contested); }
  .legend-dot.open { background: var(--open); }

  .essay-content {
    margin-left: 260px;
    margin-right: 420px;
    padding: 60px 0 0;
    min-height: 100vh;
  }

  article {
    max-width: 720px;
    margin: 0 auto;
    padding: 3rem 2rem 6rem;
  }

  .essay-header {
    margin-bottom: 4rem;
    text-align: center;
  }

  .essay-header h1 {
    font-family: var(--font-display);
    font-size: 2.5rem;
    font-weight: 500;
    line-height: 1.2;
    margin-bottom: 0.75rem;
  }

  .subtitle {
    font-size: 1.125rem;
    color: var(--text-secondary);
  }

  .essay-section {
    margin-bottom: 4rem;
    scroll-margin-top: 80px;
  }

  .section-header {
    display: flex;
    align-items: baseline;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .section-number {
    font-family: var(--font-mono);
    font-size: 0.875rem;
    color: var(--text-muted);
  }

  .section-header h2 {
    font-family: var(--font-display);
    font-size: 1.75rem;
    font-weight: 500;
  }

  .section-status {
    font-size: 0.625rem;
    padding: 0.125rem 0.5rem;
    border-radius: 3px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    cursor: help;
  }

  .section-status.established { background: rgba(74, 158, 255, 0.2); color: var(--established); }
  .section-status.derived { background: rgba(80, 200, 120, 0.2); color: var(--derived); }
  .section-status.contested { background: rgba(255, 165, 0, 0.2); color: var(--contested); }
  .section-status.open { background: rgba(168, 85, 247, 0.2); color: var(--open); }

  .section-body {
    font-size: 1rem;
    line-height: 1.8;
    color: var(--text-secondary);
  }

  .section-body.hidden {
    display: none;
  }

  .section-body :global(p) {
    margin-bottom: 1.25rem;
  }

  .section-body :global(strong) {
    color: var(--text-primary);
    font-weight: 500;
  }

  .section-body :global(em) {
    font-style: italic;
  }

  .section-body :global(code) {
    font-family: var(--font-mono);
    font-size: 0.875em;
    background: var(--depth-2);
    padding: 0.125rem 0.375rem;
    border-radius: 3px;
  }

  .section-body :global(ul), .section-body :global(ol) {
    margin: 1rem 0 1.5rem 1.5rem;
  }

  .section-body :global(li) {
    margin-bottom: 0.5rem;
  }

  .key-points {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .key-points li {
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border);
    position: relative;
    padding-left: 1.5rem;
  }

  .key-points li::before {
    content: 'â†’';
    position: absolute;
    left: 0;
    color: var(--accent);
  }

  .key-points li:last-child {
    border-bottom: none;
  }

  .academic-abstract {
    padding: 1rem;
    background: var(--depth-2);
    border-radius: 6px;
    margin-bottom: 1.5rem;
    font-size: 0.9375rem;
  }

  .academic-abstract .established { color: var(--established); }
  .academic-abstract .derived { color: var(--derived); }
  .academic-abstract .contested { color: var(--contested); }
  .academic-abstract .open { color: var(--open); }

  @media (max-width: 1100px) {
    .site-header {
      right: 0;
    }

    .essay-content {
      margin-right: 0;
    }
  }

  @media (max-width: 900px) {
    .section-nav {
      display: none;
    }

    .essay-content {
      margin-left: 0;
    }
  }
</style>
