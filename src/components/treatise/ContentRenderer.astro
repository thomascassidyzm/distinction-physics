---
/**
 * ContentRenderer.astro
 *
 * Renders an array of ContentBlocks for treatise sections.
 * Delegates to specialized components based on block type.
 */

import type { ContentBlock } from '../../content/treatise/types';
import { renderMath } from '../../lib/math';

// Import block components
import Definition from './Definition.astro';
import Theorem from './Theorem.astro';
import Axiom from './Axiom.astro';
import Derivation from './Derivation.astro';
import ThoughtExperiment from './ThoughtExperiment.astro';
import Math from './Math.astro';
import Note from './Note.astro';

interface Props {
  blocks: ContentBlock[];
}

const { blocks } = Astro.props;

/**
 * Process inline LaTeX and citations in text content
 */
function processInlineContent(text: string): string {
  // Process inline LaTeX: $...$ -> rendered HTML
  let processed = text.replace(/\$([^$]+)\$/g, (_, latex) => {
    try {
      return renderMath(latex, false);
    } catch {
      return `<code>${latex}</code>`;
    }
  });

  // Process citations: [@key] -> link
  processed = processed.replace(/\[@([^\]]+)\]/g, (_, key) => {
    return `<a href="#ref-${key}" class="citation-ref">[${key}]</a>`;
  });

  // Process glossary refs: [term] -> tooltip (simple version)
  processed = processed.replace(/\[([A-Z][^[\]]+)\]/g, (_, term) => {
    return `<span class="glossary-term" data-term="${term.toLowerCase().replace(/\s+/g, '-')}">${term}</span>`;
  });

  return processed;
}
---

<div class="content-blocks">
  {blocks.map((block) => {
    switch (block.type) {
      case 'paragraph':
        return (
          <p class:list={['paragraph', block.emphasis && `paragraph-${block.emphasis}`]}>
            <Fragment set:html={processInlineContent(block.content)} />
          </p>
        );

      case 'heading':
        const HeadingTag = `h${block.level}` as 'h2' | 'h3' | 'h4' | 'h5';
        return (
          <HeadingTag class="content-heading" id={block.id}>
            {block.content}
          </HeadingTag>
        );

      case 'list':
        const ListTag = block.style === 'numbered' || block.style === 'lettered' ? 'ol' : 'ul';
        return (
          <ListTag class:list={['content-list', `list-${block.style}`, block.tight && 'list-tight']}>
            {block.items.map((item) => (
              <li>
                <Fragment set:html={processInlineContent(item.content)} />
                {item.subItems && (
                  <ul class="sub-list">
                    {item.subItems.map((sub) => (
                      <li><Fragment set:html={processInlineContent(sub.content)} /></li>
                    ))}
                  </ul>
                )}
              </li>
            ))}
          </ListTag>
        );

      case 'quote':
        return (
          <blockquote class="content-quote">
            <p><Fragment set:html={processInlineContent(block.content)} /></p>
            {block.attribution && (
              <cite>
                â€” {block.attribution}
                {block.citation && <a href={`#ref-${block.citation}`}> [{block.citation}]</a>}
                {block.page && <span>, p. {block.page}</span>}
              </cite>
            )}
          </blockquote>
        );

      case 'definition':
        return (
          <Definition
            id={block.id}
            term={block.term}
            symbol={block.symbol}
            epistemicStatus={block.epistemicStatus}
          >
            <Fragment set:html={processInlineContent(block.definition)} />
            {block.intuition && (
              <div slot="intuition">
                <Fragment set:html={processInlineContent(block.intuition)} />
              </div>
            )}
            {block.examples && block.examples.length > 0 && (
              <div slot="examples">
                <ul>
                  {block.examples.map((ex) => (
                    <li><Fragment set:html={processInlineContent(ex)} /></li>
                  ))}
                </ul>
              </div>
            )}
          </Definition>
        );

      case 'theorem':
        return (
          <Theorem
            id={block.id}
            label={block.label}
            name={block.name}
            number={block.number}
            epistemicStatus={block.epistemicStatus}
          >
            <Fragment set:html={processInlineContent(block.statement)} />
            {block.proof && (
              <div slot="proof">
                <Fragment set:html={processInlineContent(block.proof)} />
              </div>
            )}
          </Theorem>
        );

      case 'axiom':
        return (
          <Axiom id={block.id} name={block.name}>
            <Fragment set:html={processInlineContent(block.statement)} />
            {block.grounding && (
              <div slot="grounding">
                <Fragment set:html={processInlineContent(block.grounding)} />
              </div>
            )}
          </Axiom>
        );

      case 'derivation':
        return (
          <Derivation
            id={block.id}
            name={block.name}
            from={block.from}
            epistemicStatus={block.epistemicStatus}
            steps={block.steps}
            conclusion={block.conclusion}
          />
        );

      case 'thought-experiment':
        return (
          <ThoughtExperiment
            id={block.id}
            name={block.name}
            setup={block.setup}
            analysis={block.analysis}
            conclusion={block.conclusion}
            implications={block.implications}
          />
        );

      case 'math':
        const isDisplayMath = block.display === 'block';
        return (
          <div class:list={['math-block', isDisplayMath && 'math-display']}>
            <Math latex={block.latex} display={isDisplayMath} />
            {block.label && (
              <span class="math-label" id={`eq-${block.label}`}>({block.label})</span>
            )}
          </div>
        );

      case 'note':
        return (
          <Note variant={block.variant}>
            <Fragment set:html={processInlineContent(block.content)} />
          </Note>
        );

      case 'example':
        return (
          <div class="example-block" id={block.id}>
            <div class="example-header">
              <span class="example-label">Example</span>
              {block.title && <span class="example-title">{block.title}</span>}
            </div>
            <div class="example-content">
              <Fragment set:html={processInlineContent(block.content)} />
            </div>
          </div>
        );

      case 'comparison':
        return (
          <div class="comparison-block">
            {block.title && <h4 class="comparison-title">{block.title}</h4>}
            <div class="comparison-grid">
              {block.items.map((item) => (
                <div class="comparison-item">
                  <h5 class="comparison-item-label">{item.label}</h5>
                  <div class="comparison-item-content">
                    <Fragment set:html={processInlineContent(item.description)} />
                  </div>
                </div>
              ))}
            </div>
          </div>
        );

      case 'summary':
        return (
          <aside class="summary-block">
            {block.title && <h4 class="summary-title">{block.title}</h4>}
            <ul class="summary-points">
              {block.points.map((point) => (
                <li><Fragment set:html={processInlineContent(point)} /></li>
              ))}
            </ul>
          </aside>
        );

      case 'figure':
        return (
          <figure class="content-figure" id={block.id}>
            <img src={block.src} alt={block.alt} />
            <figcaption>
              <span class="figure-label">Figure {block.number}</span>
              {block.caption && (
                <span class="figure-caption">
                  <Fragment set:html={processInlineContent(block.caption)} />
                </span>
              )}
            </figcaption>
          </figure>
        );

      case 'table':
        return (
          <div class="content-table-wrapper">
            {block.caption && (
              <div class="table-caption">
                <span class="table-label">Table {block.number}</span>
                <span class="table-title">{block.caption}</span>
              </div>
            )}
            <table class="content-table" id={block.id}>
              <thead>
                <tr>
                  {block.headers.map((h) => (
                    <th><Fragment set:html={processInlineContent(h)} /></th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {block.rows.map((row) => (
                  <tr>
                    {row.map((cell) => (
                      <td><Fragment set:html={processInlineContent(cell)} /></td>
                    ))}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        );

      default:
        return null;
    }
  })}
</div>

<style>
  .content-blocks {
    font-family: var(--font-body, 'Sora', sans-serif);
    font-size: 1rem;
    line-height: 1.8;
    color: var(--text-primary, #e8e8f0);
  }

  /* Paragraphs */
  .paragraph {
    margin: 0 0 1.5rem 0;
  }

  .paragraph-key {
    font-weight: 500;
    color: var(--accent, #4a9eff);
    padding-left: 1rem;
    border-left: 3px solid var(--accent, #4a9eff);
  }

  .paragraph-summary {
    background: var(--depth-1, #12121a);
    padding: 1rem 1.25rem;
    border-radius: 6px;
    font-style: italic;
  }

  .paragraph-conclusion {
    font-weight: 500;
    font-size: 1.0625rem;
    padding: 1.25rem;
    background: linear-gradient(135deg, rgba(74, 158, 255, 0.08) 0%, rgba(74, 158, 255, 0.02) 100%);
    border: 1px solid rgba(74, 158, 255, 0.2);
    border-radius: 8px;
  }

  /* Headings */
  .content-heading {
    font-family: var(--font-display, 'Cormorant Garamond', serif);
    color: var(--text-primary, #e8e8f0);
    margin: 2.5rem 0 1rem 0;
    line-height: 1.3;
  }

  h2.content-heading { font-size: 1.75rem; }
  h3.content-heading { font-size: 1.375rem; }
  h4.content-heading { font-size: 1.125rem; font-weight: 500; }
  h5.content-heading { font-size: 1rem; font-weight: 600; }

  /* Lists */
  .content-list {
    margin: 0 0 1.5rem 0;
    padding-left: 1.5rem;
  }

  .content-list li {
    margin-bottom: 0.5rem;
  }

  .list-tight li {
    margin-bottom: 0.25rem;
  }

  .list-lettered {
    list-style-type: lower-alpha;
  }

  .sub-list {
    margin-top: 0.5rem;
    padding-left: 1.25rem;
    font-size: 0.9375rem;
    color: var(--text-secondary, #a0a0b8);
  }

  /* Quotes */
  .content-quote {
    margin: 1.5rem 0;
    padding: 1.25rem 1.5rem;
    background: var(--depth-1, #12121a);
    border-left: 3px solid var(--text-muted, #606080);
    border-radius: 0 6px 6px 0;
  }

  .content-quote p {
    font-style: italic;
    font-size: 1.0625rem;
    margin: 0;
  }

  .content-quote cite {
    display: block;
    margin-top: 0.75rem;
    font-style: normal;
    font-size: 0.875rem;
    color: var(--text-secondary, #a0a0b8);
  }

  /* Math */
  .math-block {
    margin: 1.5rem 0;
    text-align: center;
  }

  .math-display {
    position: relative;
    padding: 1rem 0;
  }

  .math-label {
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    font-family: var(--font-mono, 'JetBrains Mono', monospace);
    font-size: 0.875rem;
    color: var(--text-secondary, #a0a0b8);
  }

  /* Examples */
  .example-block {
    margin: 1.5rem 0;
    padding: 1.25rem;
    background: var(--depth-1, #12121a);
    border: 1px solid var(--border, #2a2a3a);
    border-radius: 8px;
  }

  .example-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
  }

  .example-label {
    font-family: var(--font-mono, 'JetBrains Mono', monospace);
    font-size: 0.6875rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #50c878;
    background: rgba(80, 200, 120, 0.15);
    padding: 0.125rem 0.5rem;
    border-radius: 3px;
  }

  .example-title {
    font-weight: 500;
    color: var(--text-primary, #e8e8f0);
  }

  .example-content {
    font-size: 0.9375rem;
    color: var(--text-secondary, #a0a0b8);
  }

  /* Comparison */
  .comparison-block {
    margin: 1.5rem 0;
    padding: 1.25rem;
    background: var(--depth-1, #12121a);
    border: 1px solid var(--border, #2a2a3a);
    border-radius: 8px;
  }

  .comparison-title {
    margin: 0 0 1rem 0;
    font-family: var(--font-display, 'Cormorant Garamond', serif);
    font-size: 1.125rem;
  }

  .comparison-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }

  .comparison-item {
    padding: 1rem;
    background: var(--depth-2, #1a1a24);
    border-radius: 6px;
  }

  .comparison-item-label {
    margin: 0 0 0.5rem 0;
    font-family: var(--font-mono, 'JetBrains Mono', monospace);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--accent, #4a9eff);
  }

  .comparison-item-content {
    font-size: 0.9375rem;
    color: var(--text-secondary, #a0a0b8);
  }

  /* Summary */
  .summary-block {
    margin: 2rem 0;
    padding: 1.5rem;
    background: linear-gradient(135deg, rgba(74, 158, 255, 0.05) 0%, rgba(168, 85, 247, 0.05) 100%);
    border: 1px solid var(--border, #2a2a3a);
    border-radius: 10px;
  }

  .summary-title {
    margin: 0 0 1rem 0;
    font-family: var(--font-display, 'Cormorant Garamond', serif);
    font-size: 1.125rem;
    font-weight: 600;
  }

  .summary-points {
    margin: 0;
    padding-left: 1.25rem;
  }

  .summary-points li {
    margin-bottom: 0.5rem;
    font-size: 0.9375rem;
  }

  .summary-points li:last-child {
    margin-bottom: 0;
  }

  /* Figures */
  .content-figure {
    margin: 2rem 0;
    text-align: center;
  }

  .content-figure img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
  }

  .content-figure figcaption {
    margin-top: 0.75rem;
    font-size: 0.875rem;
    color: var(--text-secondary, #a0a0b8);
  }

  .figure-label {
    font-weight: 600;
    color: var(--text-primary, #e8e8f0);
    margin-right: 0.5rem;
  }

  /* Tables */
  .content-table-wrapper {
    margin: 1.5rem 0;
    overflow-x: auto;
  }

  .table-caption {
    margin-bottom: 0.75rem;
  }

  .table-label {
    font-weight: 600;
    color: var(--accent, #4a9eff);
    margin-right: 0.5rem;
  }

  .table-title {
    color: var(--text-secondary, #a0a0b8);
  }

  .content-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9375rem;
  }

  .content-table th,
  .content-table td {
    padding: 0.75rem 1rem;
    text-align: left;
    border: 1px solid var(--border, #2a2a3a);
  }

  .content-table th {
    background: var(--depth-2, #1a1a24);
    font-weight: 600;
    color: var(--text-primary, #e8e8f0);
  }

  .content-table td {
    background: var(--depth-1, #12121a);
    color: var(--text-secondary, #a0a0b8);
  }

  /* Inline elements */
  .content-blocks :global(.citation-ref) {
    color: var(--accent, #4a9eff);
    text-decoration: none;
    font-family: var(--font-mono, 'JetBrains Mono', monospace);
    font-size: 0.875em;
  }

  .content-blocks :global(.citation-ref:hover) {
    text-decoration: underline;
  }

  .content-blocks :global(.glossary-term) {
    border-bottom: 1px dotted var(--text-muted, #606080);
    cursor: help;
  }

  /* KaTeX inline styling */
  .content-blocks :global(.katex) {
    font-size: 1.05em;
  }
</style>
